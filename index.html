<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>鏡中詛咒 — 互動敘事地圖</title>
<style>
:root {
  --bg: #0f0f1a;
  --bg2: #161625;
  --bg3: #1e1e32;
  --text: #e8e8f0;
  --text2: #8888a0;
  --text3: #555570;
  --accent: #c084fc;
  --accent2: #533483;
  --accent-glow: #c084fc22;
  --border: #2a2a42;
  --card: #1a1a2e;
  --card-hover: #1e1e36;
  --tag-bg: rgba(74,153,153,0.15);
  --tag-text: #5db8b8;
  --success: #4ade80;
  --radius: 10px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', system-ui, -apple-system, 'Noto Sans TC', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.7;
  height: 100vh;
  overflow: hidden;
}
.app { display: flex; height: 100vh; flex-direction: column; }

/* === Game Header Banner (compact single-row) === */
.game-banner {
  background: linear-gradient(135deg, var(--accent2) 0%, var(--bg3) 50%, var(--bg2) 100%);
  padding: 7px 20px;
  border-bottom: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  gap: 12px;
}
.game-banner::before {
  content: '';
  position: absolute;
  top: 0; right: 0;
  width: 200px; height: 100%;
  background: radial-gradient(ellipse at 80% 50%, var(--accent-glow), transparent 70%);
  pointer-events: none;
}
.banner-left {
  display: flex;
  align-items: baseline;
  gap: 10px;
  flex-shrink: 0;
}
.game-banner h1 {
  font-size: 17px;
  font-weight: 700;
  color: #fff;
  letter-spacing: 0.5px;
  white-space: nowrap;
}
.game-banner .subtitle {
  font-size: 11px;
  color: rgba(255,255,255,0.38);
  font-style: italic;
  white-space: nowrap;
}
.game-banner .banner-stats {
  display: flex;
  gap: 12px;
  font-size: 11px;
  color: rgba(255,255,255,0.45);
  margin-left: auto;
  flex-wrap: wrap;
  flex-shrink: 1;
}
.game-banner .banner-stats .stat-item {
  display: flex;
  align-items: center;
  gap: 4px;
  white-space: nowrap;
}
.game-banner .banner-stats b { color: var(--accent); }
.translation-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 11px;
  font-weight: 600;
}
.translation-badge.full {
  background: rgba(74,222,128,0.15);
  color: var(--success);
}
.translation-badge.partial {
  background: rgba(251,191,36,0.15);
  color: #fbbf24;
}

/* === Toolbar === */
.toolbar {
  background: var(--bg2);
  border-bottom: 1px solid var(--border);
  padding: 8px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}
.search-box {
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text);
  font-size: 13px;
  width: 220px;
  flex-shrink: 1;
  min-width: 140px;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.search-box:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-glow);
}
.search-box::placeholder { color: var(--text3); }
.toolbar-right {
  margin-left: auto;
  display: flex;
  align-items: center;
  gap: 12px;
}
.toggle-row {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12px;
  color: var(--text2);
  cursor: pointer;
  white-space: nowrap;
  user-select: none;
}
.toggle-row input { accent-color: var(--accent); cursor: pointer; }
.toggle-row:hover { color: var(--text); }
.view-toggle { display: flex; gap: 4px; }
.view-btn {
  padding: 5px 14px;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 12px;
  cursor: pointer;
  transition: all 0.2s;
}
.view-btn:hover { background: var(--bg3); color: var(--text); }
.view-btn.active {
  background: var(--accent2);
  color: #fff;
  border-color: var(--accent2);
  box-shadow: 0 2px 8px rgba(83,52,131,0.3);
}

/* === Filter Bar === */
.filter-bar {
  background: var(--bg3);
  padding: 6px 16px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: var(--text2);
  border-bottom: 1px solid var(--border);
}
.filter-bar b { color: var(--accent); margin: 0 2px; }
.filter-bar .clear-btn {
  padding: 2px 10px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text2);
  font-size: 11px;
  cursor: pointer;
  transition: all 0.15s;
}
.filter-bar .clear-btn:hover {
  background: var(--accent2);
  color: #fff;
  border-color: var(--accent2);
}

/* === Content Area === */
.content {
  flex: 1;
  overflow-y: auto;
  padding: 16px 20px 40px;
  scroll-behavior: smooth;
}

/* === Group Headers === */
.group-header {
  width: 100%;
  background: linear-gradient(135deg, var(--accent2), var(--bg3));
  padding: 14px 20px;
  margin: 20px 0 6px 0;
  border-radius: var(--radius);
  position: sticky;
  top: 0;
  z-index: 10;
  cursor: pointer;
  user-select: none;
  display: flex;
  align-items: center;
  gap: 12px;
  transition: transform 0.1s;
  box-shadow: 0 2px 12px rgba(0,0,0,0.3);
}
.group-header:first-child { margin-top: 0; }
.group-header:active { transform: scale(0.995); }
.group-arrow {
  font-size: 12px;
  color: rgba(255,255,255,0.4);
  transition: transform 0.2s;
  flex-shrink: 0;
}
.group-arrow.open { transform: rotate(90deg); }
.group-info { flex: 1; min-width: 0; }
.group-header h2 {
  font-size: 18px;
  font-weight: 600;
  color: #fff;
  margin: 0;
  border: none;
  padding: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.group-header .group-name-en {
  font-size: 11px;
  color: rgba(255,255,255,0.35);
  font-style: italic;
  margin-top: 1px;
}
.group-header .group-stats {
  font-size: 12px;
  color: rgba(255,255,255,0.45);
  flex-shrink: 0;
}
.group-header .group-stats b { color: var(--accent); }

/* === Group Body === */
.group-body {
  display: none;
  padding: 2px 0;
}
.group-body.open { display: block; }

/* === Passage Cards === */
.passage {
  background: var(--card);
  padding: 14px 18px;
  margin: 5px 0;
  border-radius: 8px;
  border-left: 3px solid transparent;
  transition: border-color 0.2s, background 0.15s;
  position: relative;
  overflow: hidden;
}
.passage:hover {
  border-left-color: var(--accent);
  background: var(--card-hover);
}
.passage-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
  flex-wrap: wrap;
}
.passage-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--accent);
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.passage .pid {
  font-size: 10px;
  color: var(--text3);
  font-family: 'Consolas', monospace;
  flex-shrink: 0;
  margin-left: auto;
}
.passage .pname {
  font-size: 11px;
  color: var(--tag-text);
  margin-bottom: 4px;
  font-family: monospace;
}
.passage .text {
  font-size: 14.5px;
  line-height: 1.85;
  color: var(--text);
  white-space: pre-wrap;
  word-break: break-word;
}
.passage .text-en {
  font-size: 12px;
  color: var(--text2);
  margin-top: 8px;
  padding-top: 8px;
  border-top: 1px dashed var(--border);
  font-style: italic;
  line-height: 1.6;
  white-space: pre-wrap;
  max-height: 150px;
  overflow: hidden;
  position: relative;
}
.passage .text-en.collapsed::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 40px;
  background: linear-gradient(transparent, var(--card));
  pointer-events: none;
}
.passage .tag-row { margin-bottom: 6px; }
.passage .tag {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  background: var(--tag-bg);
  color: var(--tag-text);
  font-size: 11px;
  margin-right: 4px;
  margin-bottom: 2px;
}
.passage-num {
  font-size: 10px;
  color: var(--text3);
  font-family: monospace;
  position: absolute;
  top: 14px;
  right: 16px;
}

/* === Passage Images === */
.passage-bg {
  width: calc(100% + 36px);
  height: 130px;
  object-fit: cover;
  border-radius: 5px 5px 0 0;
  margin: -14px -18px 12px -18px;
  display: block;
}
.passage-cg-row {
  display: flex;
  gap: 8px;
  margin: 10px 0;
  flex-wrap: wrap;
}
.passage-cg {
  width: 160px;
  height: 110px;
  object-fit: cover;
  border-radius: 6px;
  cursor: pointer;
  border: 2px solid var(--border);
  transition: border-color 0.2s, transform 0.15s;
}
.passage-cg:hover {
  border-color: var(--accent);
  transform: scale(1.03);
}

/* === Choices === */
.passage-choices {
  margin-top: 12px;
  padding-top: 10px;
  border-top: 1px dashed var(--border);
}
.passage-choices-label {
  font-size: 11px;
  color: var(--text3);
  margin-bottom: 6px;
}
.choices-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}
.choice-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 14px;
  background: var(--accent2);
  color: rgba(255,255,255,0.85);
  border-radius: 20px;
  font-size: 12.5px;
  border: 1px solid rgba(192,132,252,0.25);
}
.choice-arrow {
  font-size: 10px;
  color: var(--accent);
}
.choice-link {
  font-size: 10px;
  color: rgba(255,255,255,0.35);
  margin-left: 2px;
}

/* === Character Badges === */
.char-badges {
  display: inline-flex;
  gap: 4px;
  flex-wrap: wrap;
}
.char-badge {
  display: inline-block;
  padding: 1px 7px;
  border-radius: 8px;
  font-size: 10px;
  font-weight: 600;
  white-space: nowrap;
  cursor: pointer;
  transition: transform 0.1s;
}
.char-badge:hover { transform: scale(1.08); }

/* === Lightbox === */
.lightbox {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.92);
  z-index: 1000;
  justify-content: center;
  align-items: center;
  cursor: zoom-out;
  animation: fadeIn 0.15s ease;
}
.lightbox.open { display: flex; }
.lightbox img {
  max-width: 92vw;
  max-height: 92vh;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 4px 40px rgba(0,0,0,0.5);
}
.lightbox-close {
  position: absolute;
  top: 16px; right: 20px;
  font-size: 28px;
  color: rgba(255,255,255,0.6);
  cursor: pointer;
  z-index: 1001;
  transition: color 0.15s;
}
.lightbox-close:hover { color: #fff; }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

/* === Character View === */
.char-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
  padding: 8px 0;
}
.char-card {
  background: var(--card);
  padding: 18px;
  border-radius: var(--radius);
  border-left: 4px solid;
  cursor: pointer;
  transition: background 0.15s, transform 0.1s, box-shadow 0.15s;
}
.char-card:hover {
  background: var(--card-hover);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
}
.char-card h3 {
  font-size: 16px;
  color: #fff;
  margin-bottom: 4px;
}
.char-card .char-name-zh {
  font-size: 12px;
  color: var(--text2);
  margin-bottom: 2px;
}
.char-card .char-role {
  font-size: 12px;
  color: var(--text3);
  margin-bottom: 8px;
  font-style: italic;
}
.char-card .char-count {
  font-size: 11px;
  color: var(--text3);
}
.char-card .char-count b { color: var(--accent); }

/* === Empty / Loading States === */
.loading {
  text-align: center;
  padding: 80px 20px;
  color: var(--text2);
}
.loading .spinner {
  display: inline-block;
  width: 36px; height: 36px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 16px;
}
@keyframes spin { to { transform: rotate(360deg); } }
.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: var(--text2);
  font-size: 14px;
}

/* === Effect Badges === */
.choice-effects { display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px; }
.effect-badge {
  font-size: 10px; padding: 1px 6px; border-radius: 8px;
  font-family: 'Consolas', monospace; white-space: nowrap;
}
.effect-up   { background: rgba(74,222,128,0.15); color: #4ade80; }
.effect-down { background: rgba(248,113,113,0.15); color: #f87171; }
.effect-set  { background: rgba(96,165,250,0.15); color: #60a5fa; }
.effect-flag { background: rgba(251,191,36,0.15); color: #fbbf24; }
.choice-target {
  font-size: 10px; color: var(--accent); cursor: pointer;
  text-decoration: underline; text-decoration-style: dashed;
  margin-left: 4px; white-space: nowrap;
}
.choice-target:hover { color: #fff; }
.choice-item { flex-direction: column; align-items: flex-start; }

/* === Conditions Panel === */
.passage-conditions { margin-top: 10px; padding-top: 8px; border-top: 1px dashed var(--border); }
.cond-toggle {
  font-size: 11px; color: var(--text3); cursor: pointer; user-select: none;
  display: inline-flex; align-items: center; gap: 4px;
}
.cond-toggle:hover { color: var(--accent); }
.cond-arrow { font-size: 9px; transition: transform 0.15s; display: inline-block; }
.cond-arrow.open { transform: rotate(90deg); }
.cond-branches { display: none; padding: 6px 0 0 10px; }
.cond-branches.open { display: block; }
.cond-branch { font-size: 12px; margin: 4px 0; padding: 4px 8px; border-left: 2px solid var(--border); }
.cond-branch:hover { border-left-color: var(--accent); }
.cond-expr { color: var(--accent); font-family: 'Consolas', monospace; font-size: 10px; display: block; margin-bottom: 2px; }
.cond-preview { color: var(--text2); font-size: 11px; line-height: 1.4; }

/* === Passage Var Changes === */
.passage-var-changes { display: flex; flex-wrap: wrap; gap: 3px; margin: 4px 0 6px; }
.var-badge {
  font-size: 10px; padding: 1px 6px; border-radius: 8px;
  font-family: 'Consolas', monospace; white-space: nowrap;
}
.var-up   { background: rgba(74,222,128,0.1); color: #4ade80; }
.var-down { background: rgba(248,113,113,0.1); color: #f87171; }
.var-set  { background: rgba(96,165,250,0.1); color: #60a5fa; }

/* === Variables Modal === */
.vars-modal-overlay {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.8); z-index: 900; justify-content: center; align-items: center;
}
.vars-modal-overlay.open { display: flex; }
.vars-modal {
  background: var(--bg2); border: 1px solid var(--border); border-radius: var(--radius);
  width: 90vw; max-width: 700px; max-height: 80vh; overflow-y: auto; padding: 20px;
}
.vars-modal h2 { font-size: 16px; color: #fff; margin-bottom: 12px; }
.vars-cat { margin-bottom: 16px; }
.vars-cat h3 { font-size: 13px; color: var(--accent); margin-bottom: 6px; border-bottom: 1px solid var(--border); padding-bottom: 4px; }
.var-row { display: flex; align-items: center; gap: 8px; padding: 3px 0; font-size: 12px; }
.var-row .var-name { color: var(--text); font-family: 'Consolas', monospace; min-width: 140px; }
.var-row .var-init { color: var(--text3); min-width: 50px; }
.var-row .var-desc { color: var(--text2); }

/* === Scrollbar === */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent2); }

/* === Mobile === */
@media (max-width: 768px) {
  .game-banner { padding: 6px 12px; flex-wrap: wrap; }
  .game-banner h1 { font-size: 15px; }
  .content { padding: 12px; }
  .passage .text { font-size: 15px; line-height: 1.9; }
  .toolbar { padding: 6px 10px; gap: 6px; }
  .search-box { width: 100%; }
  .toolbar-right { margin-left: 0; width: 100%; flex-wrap: wrap; justify-content: center; }
  .view-toggle { width: 100%; justify-content: center; }
  .group-header { padding: 12px 14px; }
  .group-header h2 { font-size: 16px; }
  .passage-bg { height: 90px; }
  .passage-cg { width: 120px; height: 80px; }
  .char-grid { grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; }
}
</style>
</head>
<body>
<div class="app">
  <!-- Game Banner (compact) -->
  <div class="game-banner">
    <div class="banner-left">
      <h1 id="gameTitle">載入中...</h1>
      <div class="subtitle" id="gameSubtitle"></div>
    </div>
    <div class="banner-stats" id="bannerStats"></div>
  </div>

  <!-- Toolbar -->
  <div class="toolbar">
    <input type="text" class="search-box" id="searchBox" placeholder="搜尋段落內容...">
    <div class="toolbar-right">
      <label class="toggle-row">
        <input type="checkbox" id="showZh" checked>
        <span>中文</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showEn">
        <span>英文原文</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showName">
        <span>段落 ID</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showImg" checked>
        <span>圖片</span>
      </label>
      <label class="toggle-row">
        <input type="checkbox" id="showBranch" checked>
        <span>分支</span>
      </label>
      <div class="view-toggle">
        <button class="view-btn active" data-view="group" id="viewGroup">按分類</button>
        <button class="view-btn" data-view="all" id="viewAll">全部段落</button>
        <button class="view-btn" data-view="char" id="viewChar">角色</button>
        <button class="view-btn" id="viewVars" onclick="showVarsModal()">變數</button>
      </div>
    </div>
  </div>

  <!-- Filter Bar (hidden by default) -->
  <div class="filter-bar" id="filterBar" style="display:none">
    <span>篩選角色: <b id="filterName"></b></span>
    <button class="clear-btn" onclick="clearCharFilter()">✕ 清除篩選</button>
  </div>

  <!-- Content -->
  <div class="content" id="content">
    <div class="loading">
      <div class="spinner"></div>
      <div>載入敘事數據中...</div>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close">&times;</span>
  <img id="lightboxImg" src="" alt="CG">
</div>

<!-- Variables Modal -->
<div class="vars-modal-overlay" id="varsModal" onclick="if(event.target===this)closeVarsModal()">
  <div class="vars-modal" id="varsModalContent"></div>
</div>

<script>
// === Config ===
const GAME_CONFIG = {"title": "A Mirror's Curse", "title_zh": "鏡中詛咒", "color_accent": "#c084fc"};

// === Character Color Palette ===
const CHAR_PALETTE = [
  '#f59e0b','#f472b6','#60a5fa','#a78bfa','#34d399',
  '#fb923c','#38bdf8','#e879f9','#fb7185','#c084fc',
  '#4ade80','#fbbf24','#f87171','#2dd4bf','#818cf8','#a3e635'
];
const _charColorCache = {};
function charColor(name) {
  if (!name) return '#666';
  if (_charColorCache[name]) return _charColorCache[name];
  let hash = 0;
  for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
  const c = CHAR_PALETTE[((hash % CHAR_PALETTE.length) + CHAR_PALETTE.length) % CHAR_PALETTE.length];
  _charColorCache[name] = c;
  return c;
}

// === State ===
let DATA = null;
let searchQuery = '';
let showZh = true;
let showEn = false;
let showName = false;
let showImg = true;
let showBranch = true;
let currentView = 'group';
let openGroups = new Set();
let charFilter = null;

// === Data Loading ===
async function loadData() {
  const resp = await fetch('data/passages.json?v=4');
  DATA = await resp.json();
  if (!DATA.meta.has_zh) {
    document.getElementById('showZh').parentElement.style.display = 'none';
    showZh = false;
    showEn = true;
    document.getElementById('showEn').checked = true;
  }
  init();
}

// === Banner ===
function renderBanner() {
  const m = DATA.meta;
  const titleZh = m.title_zh || m.title || '';
  const titleEn = m.title || '';
  document.getElementById('gameTitle').textContent = titleZh;
  document.getElementById('gameSubtitle').textContent = titleZh !== titleEn ? titleEn : '';
  document.title = titleZh + ' — 互動敘事地圖';

  const total = m.total || DATA.passages.length;
  const zhCount = m.translated_count || DATA.passages.filter(p => p.content_zh).length;
  const groupCount = (DATA.groups || []).length;
  const charCount = (DATA.characters || []).length;
  const imgCount = DATA.passages.filter(p => p.images).length;
  const choiceCount = DATA.passages.filter(p => p.choices && p.choices.length).length;
  const pct = total > 0 ? Math.round(zhCount / total * 100) : 0;

  let badgeClass = pct >= 95 ? 'full' : 'partial';
  let badgeText = pct >= 95 ? '✓ 翻譯完成' : `${pct}% 已翻譯`;

  document.getElementById('bannerStats').innerHTML = `
    <span class="stat-item"><b>${groupCount}</b> 分類</span>
    <span class="stat-item"><b>${total}</b> 段落</span>
    <span class="stat-item"><b>${charCount}</b> 角色</span>
    <span class="stat-item"><b>${imgCount}</b> 有圖片</span>
    <span class="stat-item"><b>${choiceCount}</b> 有選項</span>
    <span class="translation-badge ${badgeClass}">${badgeText}</span>
  `;
}

// === Filtering ===
function getFiltered() {
  let passages = DATA.passages;

  // Character filter
  if (charFilter) {
    passages = passages.filter(p =>
      p.characters && p.characters.includes(charFilter)
    );
  }

  // Search filter
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    passages = passages.filter(p =>
      (p.content_zh || '').toLowerCase().includes(q) ||
      (p.content || '').toLowerCase().includes(q) ||
      (p.name || '').toLowerCase().includes(q) ||
      (p.group || '').toLowerCase().includes(q) ||
      (p.characters || []).some(c => c.toLowerCase().includes(q))
    );
  }
  return passages;
}

// === Auto Title ===
function getPassageTitle(p) {
  const name = p.name || '';
  if (name && !/^(g\d|passage_|p\d|#|\d+$)/.test(name) && name.length > 2 && name.length < 80) {
    return name;
  }
  if (p.content_zh) {
    const first = p.content_zh.split(/[。！？\n]/)[0];
    if (first && first.length > 4) {
      return first.length > 60 ? first.substring(0, 57) + '...' : first;
    }
  }
  if (p.content) {
    const first = p.content.split(/[.!?\n]/)[0];
    if (first && first.length > 4) {
      return first.length > 60 ? first.substring(0, 57) + '...' : first;
    }
  }
  return name || `段落 ${p.pid}`;
}

// === Passage HTML ===
function passageHtml(p, idx) {
  const title = getPassageTitle(p);
  const pid = p.pid != null ? `<span class="pid">#${p.pid}</span>` : '';
  const pname = showName && p.name ? `<div class="pname">${escHtml(p.name)}</div>` : '';
  const tags = (p.tags && p.tags.length > 0)
    ? `<div class="tag-row">${p.tags.map(t => `<span class="tag">${escHtml(t)}</span>`).join('')}</div>`
    : '';

  // --- Images ---
  let imgHtml = '';
  if (showImg && p.images) {
    if (p.images.bg) {
      imgHtml += `<img class="passage-bg" src="${escAttr(p.images.bg)}" alt="場景" loading="lazy" onerror="this.style.display='none'">`;
    }
    if (p.images.cg) {
      const cgs = Array.isArray(p.images.cg) ? p.images.cg : [p.images.cg];
      imgHtml += '<div class="passage-cg-row">' + cgs.map(src =>
        `<img class="passage-cg" src="${escAttr(src)}" alt="CG" loading="lazy" onclick="openLightbox('${escAttr(src)}')" onerror="this.style.display='none'">`
      ).join('') + '</div>';
    }
  }

  // --- Character Badges ---
  let charHtml = '';
  if (p.characters && p.characters.length > 0) {
    charHtml = '<span class="char-badges">' + p.characters.map(c => {
      const color = charColor(c);
      return `<span class="char-badge" style="background:${color}18;color:${color};border:1px solid ${color}35" onclick="event.stopPropagation();setCharFilter('${escAttr(c)}')">${escHtml(c)}</span>`;
    }).join('') + '</span>';
  }

  // --- Text ---
  let textHtml = '';
  if (showZh && p.content_zh) {
    textHtml += `<div class="text">${formatText(p.content_zh)}</div>`;
  }
  if (showEn && p.content) {
    if (showZh && p.content_zh) {
      const isLong = p.content.length > 300;
      textHtml += `<div class="text-en${isLong ? ' collapsed' : ''}">${escHtml(p.content)}</div>`;
    } else {
      textHtml += `<div class="text">${formatText(p.content)}</div>`;
    }
  }
  if (!textHtml) {
    if (p.content_zh) {
      textHtml = `<div class="text">${formatText(p.content_zh)}</div>`;
    } else if (p.content) {
      textHtml = `<div class="text">${formatText(p.content)}</div>`;
    } else {
      textHtml = `<div class="text" style="color:var(--text3)">（無內容）</div>`;
    }
  }

  // --- Var Changes (top-level, auto-triggered) ---
  let varChangesHtml = '';
  if (showBranch && p.var_changes && p.var_changes.length > 0) {
    const badges = p.var_changes.map(e => renderEffectBadge(e)).join('');
    varChangesHtml = `<div class="passage-var-changes">${badges}</div>`;
  }

  // --- Choices ---
  let choicesHtml = '';
  if (p.choices && p.choices.length > 0) {
    const items = p.choices.map(c => {
      const text = typeof c === 'string' ? c : (c.text || c.label || JSON.stringify(c));
      const target = (typeof c === 'object' && c.target) ? c.target : '';
      const effects = (typeof c === 'object' && c.effects) ? c.effects : [];

      let targetHtml = '';
      if (showBranch && target && !target.startsWith('$')) {
        targetHtml = `<span class="choice-target" onclick="event.stopPropagation();navigateToPassage('${escAttr(target)}')">→ ${escHtml(target)}</span>`;
      } else if (showBranch && target && target.startsWith('$')) {
        targetHtml = `<span class="choice-target" style="cursor:default">→ 動態 (${escHtml(target)})</span>`;
      }

      let effectsHtml = '';
      if (showBranch && effects.length > 0) {
        effectsHtml = `<div class="choice-effects">${effects.map(e => renderEffectBadge(e)).join('')}</div>`;
      }

      return `<div class="choice-item">
        <div><span class="choice-arrow">▸</span> ${escHtml(text)}${targetHtml}</div>
        ${effectsHtml}
      </div>`;
    }).join('');
    choicesHtml = `<div class="passage-choices"><div class="passage-choices-label">選項分支 (${p.choices.length})</div><div class="choices-list">${items}</div></div>`;
  }

  // --- Conditions ---
  let condHtml = '';
  if (showBranch && p.conditions && p.conditions.length > 0) {
    const condId = 'cond_' + (p.pid || idx);
    const totalBranches = p.conditions.reduce((s, c) => s + c.branches.length, 0);
    let branchesHtml = p.conditions.map(cBlock =>
      cBlock.branches.map(b =>
        `<div class="cond-branch"><span class="cond-expr">${escHtml(b.cond)}</span><span class="cond-preview">${escHtml(b.preview)}</span></div>`
      ).join('')
    ).join('');
    condHtml = `<div class="passage-conditions">
      <span class="cond-toggle" onclick="toggleCond('${condId}')"><span class="cond-arrow" id="arr_${condId}">▶</span> 條件分支 (${totalBranches} 種)</span>
      <div class="cond-branches" id="${condId}">${branchesHtml}</div>
    </div>`;
  }

  return `<div class="passage" data-passage-name="${escAttr(p.name || '')}">
    ${imgHtml}
    <div class="passage-header">
      <span class="passage-title">${escHtml(title)}</span>
      ${charHtml}
      ${pid}
    </div>
    ${pname}${tags}${varChangesHtml}${textHtml}${choicesHtml}${condHtml}
  </div>`;
}

function formatText(s) {
  if (!s) return '';
  let html = escHtml(s);
  html = html.replace(/\n\n+/g, '</p><p>').replace(/\n/g, '<br>');
  return '<p>' + html + '</p>';
}

function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function escAttr(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

// === Lightbox ===
function openLightbox(src) {
  const lb = document.getElementById('lightbox');
  document.getElementById('lightboxImg').src = src;
  lb.classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeLightbox() {
  const lb = document.getElementById('lightbox');
  lb.classList.remove('open');
  document.getElementById('lightboxImg').src = '';
  document.body.style.overflow = '';
}
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeLightbox(); closeVarsModal(); }
});

// === Effect Badge Rendering ===
function renderEffectBadge(e) {
  const bare = (e.var || '').replace(/^\$/, '');
  const desc = (DATA.variables && DATA.variables[e.var]) ? DATA.variables[e.var].description_zh : '';
  const label = desc || bare;

  if (e.op === '+=' || e.op === 'clamp+') {
    return `<span class="effect-badge effect-up" title="${bare}">${label} +${e.val}</span>`;
  } else if (e.op === '-=' || e.op === 'clamp-') {
    return `<span class="effect-badge effect-down" title="${bare}">${label} -${e.val}</span>`;
  } else if (e.val === 'true' || e.val === 'false') {
    return `<span class="effect-badge effect-flag" title="${bare}">${label} = ${e.val}</span>`;
  } else {
    return `<span class="effect-badge effect-set" title="${bare}">${label} = ${e.val}</span>`;
  }
}

// === Conditions Toggle ===
function toggleCond(id) {
  const el = document.getElementById(id);
  const arr = document.getElementById('arr_' + id);
  if (el) {
    const open = el.classList.toggle('open');
    if (arr) arr.classList.toggle('open', open);
  }
}

// === Navigate to Passage ===
function navigateToPassage(name) {
  const p = DATA.passages.find(p => p.name === name);
  if (!p) return;
  charFilter = null;
  updateFilterBar();
  searchQuery = '';
  document.getElementById('searchBox').value = '';
  openGroups.add(p.group);
  if (currentView === 'char') currentView = 'group';
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(currentView === 'group' ? 'viewGroup' : 'viewAll').classList.add('active');
  resetAndRender();
  setTimeout(() => {
    const el = document.querySelector(`[data-passage-name="${CSS.escape(name)}"]`);
    if (el) {
      el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      el.style.borderLeftColor = '#fbbf24';
      setTimeout(() => el.style.borderLeftColor = '', 2000);
    }
  }, 200);
}

// === Variables Modal ===
const CAT_ZH = {
  identity_axis: '身份軸', personality: '性格', identity: '認同',
  skill: '技能', relationship: '關係', romance: '浪漫',
  transformation: '變化進度', game_state: '遊戲狀態',
  decision_flag: '決策旗標', wardrobe: '服裝', other: '其他'
};
function showVarsModal() {
  if (!DATA || !DATA.variables) return;
  const vars = DATA.variables;
  // Group by category
  const cats = {};
  for (const [k, v] of Object.entries(vars)) {
    const cat = v.category || 'other';
    if (!cats[cat]) cats[cat] = [];
    cats[cat].push({ name: k, ...v });
  }
  // Render (skip 'other' and 'decision_flag' if too many)
  const order = ['identity_axis','personality','identity','relationship','romance','skill','transformation','game_state','wardrobe','decision_flag','other'];
  let html = '<h2>遊戲變數總覽 (' + Object.keys(vars).length + ')</h2>';
  for (const cat of order) {
    if (!cats[cat]) continue;
    const items = cats[cat];
    if ((cat === 'decision_flag' || cat === 'other') && items.length > 30) {
      html += `<div class="vars-cat"><h3>${CAT_ZH[cat] || cat} (${items.length} 個，僅顯示前 30)</h3>`;
      items.slice(0, 30).forEach(v => {
        html += `<div class="var-row"><span class="var-name">${escHtml(v.name)}</span><span class="var-init">${escHtml(v.init)}</span><span class="var-desc">${escHtml(v.description_zh)}</span></div>`;
      });
    } else {
      html += `<div class="vars-cat"><h3>${CAT_ZH[cat] || cat} (${items.length})</h3>`;
      items.forEach(v => {
        html += `<div class="var-row"><span class="var-name">${escHtml(v.name)}</span><span class="var-init">${escHtml(v.init)}</span><span class="var-desc">${escHtml(v.description_zh)}</span></div>`;
      });
    }
    html += '</div>';
  }
  document.getElementById('varsModalContent').innerHTML = html;
  document.getElementById('varsModal').classList.add('open');
}
function closeVarsModal() {
  document.getElementById('varsModal').classList.remove('open');
}

// === Character Filter ===
function setCharFilter(name) {
  charFilter = name;
  updateFilterBar();
  if (currentView === 'char') {
    setActiveView('group');
  } else {
    resetAndRender();
  }
}
function clearCharFilter() {
  charFilter = null;
  updateFilterBar();
  resetAndRender();
}
function updateFilterBar() {
  const bar = document.getElementById('filterBar');
  if (charFilter) {
    bar.style.display = 'flex';
    document.getElementById('filterName').textContent = charFilter;
  } else {
    bar.style.display = 'none';
  }
}

// === Group View ===
function renderGroupView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  const groups = groupPassages(passages);

  if (groups.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }

  groups.forEach(([gName, gPassages]) => {
    const isOpen = openGroups.has(gName);

    const gInfo = (DATA.groups || []).find(g => g.id === gName);
    const displayName = gInfo ? (gInfo.name_zh || gInfo.name || gName) : gName;
    const displayNameEn = gInfo && gInfo.name_zh && gInfo.name !== gInfo.name_zh ? gInfo.name : '';

    // Count stats for group
    const zhCount = gPassages.filter(p => p.content_zh).length;
    const imgCount = gPassages.filter(p => p.images).length;

    const header = document.createElement('div');
    header.className = 'group-header';
    header.innerHTML = `
      <span class="group-arrow${isOpen ? ' open' : ''}">▶</span>
      <div class="group-info">
        <h2>${escHtml(displayName)}</h2>
        ${displayNameEn ? `<div class="group-name-en">${escHtml(displayNameEn)}</div>` : ''}
      </div>
      <div class="group-stats">
        <b>${gPassages.length}</b> 段落
        ${imgCount > 0 ? ` · ${imgCount} 圖` : ''}
      </div>
    `;

    const body = document.createElement('div');
    body.className = 'group-body' + (isOpen ? ' open' : '');

    header.addEventListener('click', () => {
      const nowOpen = body.classList.toggle('open');
      header.querySelector('.group-arrow').classList.toggle('open', nowOpen);
      if (nowOpen) {
        openGroups.add(gName);
        if (!body.dataset.rendered) {
          renderPassageChunked(body, gPassages, 0);
          body.dataset.rendered = '1';
        }
      } else {
        openGroups.delete(gName);
      }
    });

    if (isOpen && !body.dataset.rendered) {
      renderPassageChunked(body, gPassages, 0);
      body.dataset.rendered = '1';
    }

    content.appendChild(header);
    content.appendChild(body);
  });
}

// === Grouping (sorted by DATA.groups order) ===
function groupPassages(passages) {
  const groups = new Map();
  passages.forEach(p => {
    const g = p.group || '（未分類）';
    if (!groups.has(g)) groups.set(g, []);
    groups.get(g).push(p);
  });

  // Use DATA.groups ordering
  const groupOrder = new Map();
  (DATA.groups || []).forEach((g, i) => groupOrder.set(g.id, i));

  const sorted = Array.from(groups.entries()).sort((a, b) => {
    const oa = groupOrder.has(a[0]) ? groupOrder.get(a[0]) : 9999;
    const ob = groupOrder.has(b[0]) ? groupOrder.get(b[0]) : 9999;
    if (oa !== ob) return oa - ob;
    return a[0].localeCompare(b[0]);
  });
  return sorted;
}

// === All View ===
function renderAllView(passages) {
  const content = document.getElementById('content');
  content.innerHTML = '';
  if (passages.length === 0) {
    content.innerHTML = '<div class="empty-state">未找到匹配的段落</div>';
    return;
  }
  renderPassageChunked(content, passages, 0);
}

// === Character View ===
function renderCharView() {
  const content = document.getElementById('content');
  content.innerHTML = '';

  // Build character stats from all passages
  const charStats = new Map();
  DATA.passages.forEach(p => {
    (p.characters || []).forEach(c => {
      if (!charStats.has(c)) charStats.set(c, 0);
      charStats.set(c, charStats.get(c) + 1);
    });
  });

  if (charStats.size === 0) {
    content.innerHTML = '<div class="empty-state">此遊戲沒有角色資料</div>';
    return;
  }

  // Get character metadata
  const charMeta = new Map();
  (DATA.characters || []).forEach(c => charMeta.set(c.name, c));

  // Sort by appearance count desc
  const chars = Array.from(charStats.entries()).sort((a, b) => b[1] - a[1]);

  const grid = document.createElement('div');
  grid.className = 'char-grid';

  chars.forEach(([name, count]) => {
    const meta = charMeta.get(name) || {};
    const color = charColor(name);
    const card = document.createElement('div');
    card.className = 'char-card';
    card.style.borderLeftColor = color;

    const role = meta.role || meta.description || '';
    card.innerHTML = `
      <h3 style="color:${color}">${escHtml(name)}</h3>
      ${role ? `<div class="char-role">${escHtml(role)}</div>` : ''}
      <div class="char-count">出場 <b>${count}</b> 段落</div>
    `;

    card.addEventListener('click', () => {
      setCharFilter(name);
    });
    grid.appendChild(card);
  });

  content.appendChild(grid);
}

// === Chunked Rendering ===
function renderPassageChunked(container, passages, startIdx) {
  const CHUNK = 60;
  const end = Math.min(startIdx + CHUNK, passages.length);
  let html = '';
  for (let i = startIdx; i < end; i++) {
    html += passageHtml(passages[i], i);
  }
  container.insertAdjacentHTML('beforeend', html);

  if (end < passages.length) {
    const sentinel = document.createElement('div');
    sentinel.className = 'loading';
    sentinel.style.padding = '20px';
    sentinel.innerHTML = `<div style="font-size:12px;color:var(--text3)">載入更多 (${end}/${passages.length})...</div>`;
    container.appendChild(sentinel);

    const obs = new IntersectionObserver((entries) => {
      if (entries[0].isIntersecting) {
        obs.disconnect();
        sentinel.remove();
        renderPassageChunked(container, passages, end);
      }
    });
    obs.observe(sentinel);
  }
}

// === Render ===
function resetAndRender() {
  if (currentView === 'char') {
    renderCharView();
    return;
  }
  const passages = getFiltered();
  if (currentView === 'group') {
    renderGroupView(passages);
  } else {
    renderAllView(passages);
  }
}

function setActiveView(view) {
  currentView = view;
  document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
  const btnId = view === 'group' ? 'viewGroup' : view === 'char' ? 'viewChar' : 'viewAll';
  document.getElementById(btnId).classList.add('active');
  resetAndRender();
}

// === Init ===
function init() {
  renderBanner();

  let searchTimeout;
  document.getElementById('searchBox').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchQuery = e.target.value.trim();
      resetAndRender();
    }, 300);
  });

  document.getElementById('showZh').addEventListener('change', (e) => {
    showZh = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });
  document.getElementById('showEn').addEventListener('change', (e) => {
    showEn = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });
  document.getElementById('showName').addEventListener('change', (e) => {
    showName = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });
  document.getElementById('showImg').addEventListener('change', (e) => {
    showImg = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });
  document.getElementById('showBranch').addEventListener('change', (e) => {
    showBranch = e.target.checked;
    clearRenderedCache();
    resetAndRender();
  });

  document.getElementById('viewGroup').addEventListener('click', () => setActiveView('group'));
  document.getElementById('viewAll').addEventListener('click', () => setActiveView('all'));
  document.getElementById('viewChar').addEventListener('click', () => setActiveView('char'));

  resetAndRender();
}

function clearRenderedCache() {
  openGroups.clear();
  document.querySelectorAll('.group-body').forEach(div => {
    div.dataset.rendered = '';
  });
}

loadData();
</script>
</body>
</html>
